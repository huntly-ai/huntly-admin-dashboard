// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL_SENT
  NEGOTIATION
  WON
  LOST
}

enum LeadSource {
  WEBSITE
  REFERRAL
  SOCIAL_MEDIA
  ZEROS_A_DIREITA
  EVENT
  OTHER
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  CHURNED
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum BillingType {
  FIXED_PRICE
  HOURLY_RATE
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionCategory {
  // Income categories
  PROJECT_PAYMENT
  CONSULTING
  LICENSE
  SUBSCRIPTION
  OTHER_INCOME
  
  // Expense categories
  SALARIES
  INFRASTRUCTURE
  SOFTWARE
  MARKETING
  OFFICE
  TAXES
  OTHER_EXPENSE
}

enum ContractStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
  SUSPENDED
}

enum PaymentStatus {
  PENDING
  PAID
  LATE
  CANCELLED
}

enum MemberRole {
  DEVELOPER
  DESIGNER
  PROJECT_MANAGER
  PRODUCT_MANAGER
  QA_ENGINEER
  DEVOPS
  DATA_SCIENTIST
  BUSINESS_ANALYST
  FOUNDER
  CEO
  CTO
  CFO
  ADVISOR
  OTHER
}

enum MemberStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
}

model Lead {
  id          String      @id @default(cuid())
  name        String
  email       String?
  phone       String
  company     String?
  position    String?
  status      LeadStatus  @default(NEW)
  source      LeadSource  @default(OTHER)
  notes       String?
  estimatedValue Float?
  
  // Conversion tracking
  convertedToClientId String?   @unique
  convertedToClient   Client?   @relation(fields: [convertedToClientId], references: [id])
  convertedAt         DateTime?
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@index([status])
  @@index([source])
  @@index([createdAt])
  meetings        Meeting[]
}

model Client {
  id          String        @id @default(cuid())
  name        String
  email       String        @unique
  phone       String?
  company     String?
  position    String?
  status      ClientStatus  @default(ACTIVE)
  
  // Business info
  cnpj        String?       @unique
  address     String?
  website     String?
  notes       String?
  
  // Relationship
  projects    Project[]
  transactions Transaction[]
  contracts   Contract[]
  
  // Conversion info
  leadId      String?       @unique
  lead        Lead?
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([status])
  @@index([createdAt])
  meetings        Meeting[]
}

model Project {
  id          String          @id @default(cuid())
  name        String
  description String?
  status      ProjectStatus   @default(PLANNING)
  priority    ProjectPriority @default(MEDIUM)
  
  // Financial
  billingType  BillingType     @default(FIXED_PRICE)
  projectValue Float           @default(0) // Valor total cobrado do cliente (usado em FIXED_PRICE)
  hourlyRate   Float?          // Valor por hora (usado em HOURLY_RATE)
  
  // Dates
  startDate   DateTime?
  endDate     DateTime?
  deadline    DateTime?
  
  // Client relationship
  clientId    String
  client      Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Related transactions
  transactions Transaction[]
  
  // Related contracts
  contractProjects ContractProject[]
  
  // Team allocation
  projectTeams ProjectTeam[]
  projectMembers ProjectMember[]
  
  // Scrum / Tasks
  epics       Epic[]
  stories     Story[]
  tasks       Task[]
  
  // Notes
  notes       String?
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  @@index([status])
  @@index([priority])
  @@index([clientId])
  @@index([startDate])
  @@index([deadline])
  @@index([billingType])
}

model Transaction {
  id          String              @id @default(cuid())
  type        TransactionType
  category    TransactionCategory
  amount      Float
  description String

  // Relationships
  projectId   String?
  project     Project?            @relation(fields: [projectId], references: [id], onDelete: SetNull)

  clientId    String?
  client      Client?             @relation(fields: [clientId], references: [id], onDelete: SetNull)

  internalProjectId   String?
  internalProject     InternalProject? @relation(fields: [internalProjectId], references: [id], onDelete: SetNull)

  // Date
  date        DateTime            @default(now())

  // Additional info
  invoiceNumber String?
  paymentMethod String?
  notes       String?

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([type])
  @@index([category])
  @@index([date])
  @@index([projectId])
  @@index([clientId])
  @@index([internalProjectId])
}

model Contract {
  id              String          @id @default(cuid())
  contractNumber  String          @unique
  title           String
  description     String?
  status          ContractStatus  @default(DRAFT)
  
  // Financial
  totalValue      Float
  
  // Dates
  startDate       DateTime
  endDate         DateTime
  signedDate      DateTime?
  
  // Client relationship
  clientId        String
  client          Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Related projects (many-to-many)
  contractProjects ContractProject[]
  
  // Payments
  payments        ContractPayment[]
  
  // Legal
  terms           String?         // Contract terms and conditions
  attachments     String?         // JSON array of file URLs/paths
  
  // Additional info
  notes           String?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([status])
  @@index([clientId])
  @@index([startDate])
  @@index([endDate])
}

model ContractProject {
  id          String    @id @default(cuid())
  contractId  String
  projectId   String
  
  contract    Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())
  
  @@unique([contractId, projectId])
  @@index([contractId])
  @@index([projectId])
}

model ContractPayment {
  id              String        @id @default(cuid())
  contractId      String
  contract        Contract      @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  installmentNumber Int         // 1, 2, 3, etc.
  amount          Float
  dueDate         DateTime
  paymentDate     DateTime?
  status          PaymentStatus @default(PENDING)
  
  // Payment info
  paymentMethod   String?
  transactionId   String?       // Reference to Transaction if payment is completed
  invoiceNumber   String?
  
  notes           String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([contractId])
  @@index([status])
  @@index([dueDate])
}

model User {
  id              String        @id @default(cuid())
  email           String        @unique
  password        String        // Hashed password
  memberId        String?       @unique
  member          TeamMember?   @relation(fields: [memberId], references: [id])
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([email])
}

model TeamMember {
  id              String        @id @default(cuid())
  name            String
  email           String        @unique
  phone           String?
  role            MemberRole    // Primary role
  roles           String?       // JSON array of all roles (including primary)
  status          MemberStatus  @default(ACTIVE)
  
  // User account relationship
  user            User?
  
  // Additional info
  department      String?
  hireDate        DateTime?
  avatar          String?       // URL to avatar image
  bio             String?
  skills          String?       // JSON array of skills
  
  // Relationships
  teamMemberships TeamMembership[]
  projectMembers  ProjectMember[]
  taskMembers     TaskMember[]
  storyMembers    StoryMember[]
  meetingMembers  MeetingMember[]

  // Suggestions
  suggestions         Suggestion[]
  suggestionVotes     SuggestionVote[]
  suggestionComments  SuggestionComment[]

  // API Keys created by this member
  apiKeys         ApiKey[]

  notes           String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([status])
  @@index([role])
}

model Team {
  id              String        @id @default(cuid())
  name            String
  description     String?
  
  // Team lead
  leadId          String?
  
  // Relationships
  teamMemberships TeamMembership[]
  projectTeams    ProjectTeam[]
  taskTeams       TaskTeam[]
  storyTeams      StoryTeam[]
  meetingTeams    MeetingTeam[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model TeamMembership {
  id              String        @id @default(cuid())
  teamId          String
  memberId        String
  
  team            Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  member          TeamMember    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  joinedAt        DateTime      @default(now())
  
  @@unique([teamId, memberId])
  @@index([teamId])
  @@index([memberId])
}

model ProjectTeam {
  id              String        @id @default(cuid())
  projectId       String
  teamId          String
  
  project         Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team            Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  assignedAt      DateTime      @default(now())
  
  @@unique([projectId, teamId])
  @@index([projectId])
  @@index([teamId])
}

model ProjectMember {
  id              String        @id @default(cuid())
  projectId       String
  memberId        String
  
  project         Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  member          TeamMember    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  // Role in this specific project (can be different from their main role)
  projectRole     String?
  
  assignedAt      DateTime      @default(now())
  
  @@unique([projectId, memberId])
  @@index([projectId])
  @@index([memberId])
}

enum EpicStatus {
  TODO
  IN_PROGRESS
  DONE
}

model Epic {
  id          String        @id @default(cuid())
  title       String
  description String?
  status      EpicStatus    @default(TODO)
  priority    TaskPriority  @default(MEDIUM)
  
  startDate   DateTime?
  endDate     DateTime?
  
  projectId   String
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  stories     Story[]
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([projectId])
  @@index([status])
}

enum StoryStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
}

model Story {
  id          String        @id @default(cuid())
  title       String
  description String?
  status      StoryStatus   @default(TODO)
  priority    TaskPriority  @default(MEDIUM)
  points      Int?          @default(0) // Story points
  
  // Project link
  projectId   String
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Epic link (optional)
  epicId      String?
  epic        Epic?         @relation(fields: [epicId], references: [id], onDelete: SetNull)
  
  // Tasks (Sub-tasks)
  tasks       Task[]
  
  // Members/Teams
  storyMembers StoryMember[]
  storyTeams   StoryTeam[]
  
  // Order in backlog/board
  order       Int           @default(0)
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([projectId])
  @@index([epicId])
  @@index([status])
}

model StoryMember {
  id        String     @id @default(cuid())
  storyId   String
  memberId  String
  
  story     Story      @relation(fields: [storyId], references: [id], onDelete: Cascade)
  member    TeamMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  assignedAt DateTime  @default(now())
  
  @@unique([storyId, memberId])
  @@index([storyId])
  @@index([memberId])
}

model StoryTeam {
  id        String   @id @default(cuid())
  storyId   String
  teamId    String
  
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  assignedAt DateTime @default(now())
  
  @@unique([storyId, teamId])
  @@index([storyId])
  @@index([teamId])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Task {
  id              String        @id @default(cuid())
  title           String
  description     String?
  status          TaskStatus    @default(TODO)
  priority        TaskPriority  @default(MEDIUM)
  
  // Project relationship
  projectId       String
  project         Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Story relationship (optional - task can be part of a story)
  storyId         String?
  story           Story?        @relation(fields: [storyId], references: [id], onDelete: SetNull)
  
  // Task assignments
  taskMembers     TaskMember[]
  taskTeams       TaskTeam[]
  
  // Dates
  dueDate         DateTime?
  completedAt     DateTime?
  
  // Order in kanban column
  order           Int           @default(0)
  
  // Additional info
  estimatedHours  Float?
  actualHours     Float?
  tags            String?       // JSON array of tags
  attachments     String?       // JSON array of file URLs
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([projectId])
  @@index([storyId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
}

model TaskMember {
  id              String        @id @default(cuid())
  taskId          String
  memberId        String
  
  task            Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  member          TeamMember    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  assignedAt      DateTime      @default(now())
  
  @@unique([taskId, memberId])
  @@index([taskId])
  @@index([memberId])
}

model TaskTeam {
  id              String        @id @default(cuid())
  taskId          String
  teamId          String
  
  task            Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  team            Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  assignedAt      DateTime      @default(now())
  
  @@unique([taskId, teamId])
  @@index([taskId])
  @@index([teamId])
}

model Meeting {
  id              String        @id @default(cuid())
  title           String
  description     String?
  
  // Date and time
  startDate       DateTime
  endDate         DateTime?
  
  // Location/Link
  location        String?       // Physical location or video call link
  
  // Relationships
  leadId          String?
  lead            Lead?         @relation(fields: [leadId], references: [id], onDelete: SetNull)
  
  clientId        String?
  client          Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)
  
  // Participants
  meetingMembers  MeetingMember[]
  meetingTeams    MeetingTeam[]
  
  // Tags/Subject
  tags            String?       // JSON array of tags/subjects
  
  // Notes
  notes           String?
  recordingUrl    String?       // URL to meeting recording if available
  
  // Status
  status          String        @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([leadId])
  @@index([clientId])
  @@index([startDate])
  @@index([status])
}

model MeetingMember {
  id              String        @id @default(cuid())
  meetingId       String
  memberId        String
  
  meeting         Meeting       @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  member          TeamMember    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  // RSVP status
  rsvpStatus      String        @default("PENDING") // PENDING, ACCEPTED, DECLINED, TENTATIVE
  rsvpAt          DateTime?
  
  createdAt       DateTime      @default(now())
  
  @@unique([meetingId, memberId])
  @@index([meetingId])
  @@index([memberId])
}

model MeetingTeam {
  id              String        @id @default(cuid())
  meetingId       String
  teamId          String

  meeting         Meeting       @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  team            Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt       DateTime      @default(now())

  @@unique([meetingId, teamId])
  @@index([meetingId])
  @@index([teamId])
}

// ==================== SUGGESTIONS ====================

enum SuggestionCategory {
  FINANCEIRO
  GESTAO
  PROJETOS
  EQUIPE
  PROCESSOS
  TECNOLOGIA
  OUTRO
}

enum SuggestionStatus {
  ABERTA
  EM_ANALISE
  APROVADA
  IMPLEMENTADA
  REJEITADA
}

model Suggestion {
  id              String              @id @default(cuid())
  title           String
  description     String
  category        SuggestionCategory
  status          SuggestionStatus    @default(ABERTA)

  // Author
  authorId        String
  author          TeamMember          @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Interactions
  votes           SuggestionVote[]
  comments        SuggestionComment[]

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([category])
  @@index([status])
  @@index([authorId])
  @@index([createdAt])
}

model SuggestionVote {
  id              String        @id @default(cuid())
  suggestionId    String
  memberId        String

  suggestion      Suggestion    @relation(fields: [suggestionId], references: [id], onDelete: Cascade)
  member          TeamMember    @relation(fields: [memberId], references: [id], onDelete: Cascade)

  createdAt       DateTime      @default(now())

  @@unique([suggestionId, memberId])
  @@index([suggestionId])
  @@index([memberId])
}

model SuggestionComment {
  id              String        @id @default(cuid())
  suggestionId    String
  authorId        String
  content         String

  suggestion      Suggestion    @relation(fields: [suggestionId], references: [id], onDelete: Cascade)
  author          TeamMember    @relation(fields: [authorId], references: [id], onDelete: Cascade)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([suggestionId])
  @@index([authorId])
}

// ==================== INTERNAL PROJECTS ====================

enum InternalProjectStatus {
  ACTIVE
  ARCHIVED
}

model InternalProject {
  id          String                @id @default(cuid())
  name        String
  description String?
  status      InternalProjectStatus @default(ACTIVE)

  // Financial tracking via transactions
  transactions Transaction[]

  // Scrum / Tasks
  epics       InternalEpic[]
  stories     InternalStory[]
  tasks       InternalTask[]

  // API Keys scoped to this project
  apiKeys     ApiKey[]

  // Metadata
  icon        String?               // Optional icon identifier
  color       String?               // Optional color for UI display

  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  @@index([status])
  @@index([createdAt])
}

// ==================== INTERNAL PROJECT SCRUM ====================

model InternalEpic {
  id          String            @id @default(cuid())
  title       String
  description String?
  status      EpicStatus        @default(TODO)
  priority    TaskPriority      @default(MEDIUM)

  startDate   DateTime?
  endDate     DateTime?

  internalProjectId String
  internalProject   InternalProject @relation(fields: [internalProjectId], references: [id], onDelete: Cascade)

  stories     InternalStory[]

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([internalProjectId])
  @@index([status])
}

model InternalStory {
  id          String            @id @default(cuid())
  title       String
  description String?
  status      StoryStatus       @default(TODO)
  priority    TaskPriority      @default(MEDIUM)
  points      Int?              @default(0)

  internalProjectId String
  internalProject   InternalProject @relation(fields: [internalProjectId], references: [id], onDelete: Cascade)

  epicId      String?
  epic        InternalEpic?     @relation(fields: [epicId], references: [id], onDelete: SetNull)

  tasks       InternalTask[]

  order       Int               @default(0)

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([internalProjectId])
  @@index([epicId])
  @@index([status])
}

model InternalTask {
  id              String            @id @default(cuid())
  title           String
  description     String?
  status          TaskStatus        @default(TODO)
  priority        TaskPriority      @default(MEDIUM)

  internalProjectId String
  internalProject   InternalProject @relation(fields: [internalProjectId], references: [id], onDelete: Cascade)

  storyId         String?
  story           InternalStory?    @relation(fields: [storyId], references: [id], onDelete: SetNull)

  dueDate         DateTime?
  completedAt     DateTime?

  order           Int               @default(0)

  estimatedHours  Float?
  actualHours     Float?
  tags            String?
  attachments     String?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([internalProjectId])
  @@index([storyId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
}

// ==================== API KEYS ====================

model ApiKey {
  id          String    @id @default(cuid())
  name        String    // Friendly name for the key
  key         String    @unique // The actual API key (hashed)
  prefix      String    // First 8 chars for identification (e.g., "hntly_ab")

  // Permissions
  permissions String[]  // Array of permissions: ["transactions:read", "transactions:write", etc.]

  // Scope
  internalProjectId String?           // Optional: restrict to specific internal project
  internalProject   InternalProject?  @relation(fields: [internalProjectId], references: [id], onDelete: Cascade)

  // Metadata
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  isActive    Boolean   @default(true)

  // Audit
  createdById String?
  createdBy   TeamMember? @relation(fields: [createdById], references: [id], onDelete: SetNull)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([key])
  @@index([prefix])
  @@index([isActive])
}
